function e(e){const t=e.readDoubleLE();return new Date(Math.round(86400*(t-25569)*1e3))}function t(e,t){return function(e,t){const n=Buffer.from(e);let i=0,a=0;for(let r=0;r<e.length;++r)i=(i+1)%256,a=(a+t[i])%256,[t[i],t[a]]=[t[a],t[i]],n[r]^=t[(t[i]+t[a])%256];return n}(e,function(e){const t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=e;let n=0;for(let i=0;i<256;++i)n=(n+t[i]+e[i%e.length])%256,[t[i],t[n]]=[t[n],t[i]];return t}(t))}const n=Object.freeze({value:1033,version:-1}),i=Object.freeze({value:1033,version:0}),a=Object.freeze({value:1033,version:1}),r={legacyFormat:"Jet4",codecType:0,pageSize:4096,textEncoding:"ucs-2",defaultSortOrder:i,databaseDefinitionPage:{encryptedSize:128,passwordSize:40,creationDateOffset:114,defaultSortOrder:{offset:110,size:4}},dataPage:{recordCountOffset:12,record:{countOffset:12,columnCountSize:2}},tableDefinitionPage:{rowCountOffset:16,variableColumnCountOffset:43,columnCountOffset:45,logicalIndexCountOffset:47,realIndexCountOffset:51,realIndexStartOffset:63,realIndexEntrySize:12,columnsDefinition:{typeOffset:0,indexOffset:5,variableIndexOffset:7,flagsOffset:15,fixedIndexOffset:21,sizeOffset:23,entrySize:25},columnNames:{nameLengthSize:2},usageMapOffset:55}},o={...r,codecType:2},f={...o,defaultSortOrder:a},s=f,l=s,u=l,d={legacyFormat:"Jet3",codecType:0,pageSize:2048,textEncoding:"utf8",defaultSortOrder:n,databaseDefinitionPage:{encryptedSize:126,passwordSize:20,creationDateOffset:null,defaultSortOrder:{offset:58,size:2}},dataPage:{recordCountOffset:8,record:{countOffset:8,columnCountSize:1}},tableDefinitionPage:{rowCountOffset:12,columnCountOffset:25,variableColumnCountOffset:25,logicalIndexCountOffset:27,realIndexCountOffset:31,realIndexStartOffset:43,realIndexEntrySize:8,columnsDefinition:{typeOffset:0,indexOffset:1,variableIndexOffset:3,flagsOffset:13,fixedIndexOffset:14,sizeOffset:16,entrySize:18},columnNames:{nameLengthSize:1},usageMapOffset:35}},c={...r,codecType:1},h=Buffer.from("MSISAM Database","ascii");function g(e){const t=e[20];switch(t){case 0:return d;case 1:return e.slice(4,4+h.length).equals(h)?c:r;case 2:return o;case 3:return f;case 4:return s;case 5:return l;case 6:return u;default:throw new Error(`Unsupported version '${t}'`)}}function b(e,t){const n=t%8;return!!(e[Math.floor(t/8)]&1<<n)}function m(e){return Math.floor((e+7)/8)}function D(e,t){const n=Math.max(e.length,t.length),i=Buffer.allocUnsafe(n);for(let a=0;a<n;a++)i[a]=e[a]^t[a];return i}function p(e){return e.every((e=>0===e))}function P(e){const n=e.slice(62,66);return p(n)?e=>e:(e,i)=>t(e,function(e,t){const n=Buffer.alloc(4);return n.writeUInt32LE(t),D(n,e)}(n,i))}var I;!function(e){e[e.DatabaseDefinitionPage=0]="DatabaseDefinitionPage",e[e.DataPage=1]="DataPage",e[e.TableDefinition=2]="TableDefinition",e[e.IntermediateIndexPage=3]="IntermediateIndexPage",e[e.LeafIndexPages=4]="LeafIndexPages",e[e.PageUsageBitmaps=5]="PageUsageBitmaps"}(I||(I={}));var O=I;function w(e,t){if(e[0]!==t)throw new Error(`Wrong page type. Expected ${t} but received ${e[0]}.`)}function x(e,t){if("utf8"===t.textEncoding)return e.toString("utf8");if(e.length<=2||255!=(255&e.readUInt8(0))||254!=(255&e.readUInt8(1)))return e.toString("ucs-2");let n=!0,i=2;const a=Buffer.alloc(2*(e.length-i));let r=0;for(;i<e.length;){const t=e.readUInt8(i++);0===t?n=!n:n?(a[r++]=t,a[r++]=0):e.length-i>=2&&(a[r++]=t,a[r++]=e.readUInt8(i++))}return a.slice(0,r).toString("ucs-2")}class y{constructor(e){this.buffer=e,w(this.buffer,O.DatabaseDefinitionPage),this.format=g(this.buffer),this.databaseDefinitionPage=Buffer.alloc(this.format.pageSize),this.buffer.copy(this.databaseDefinitionPage,0,0,this.format.pageSize),function(e,n){t(e.slice(24,24+n.databaseDefinitionPage.encryptedSize),S).copy(e,24)}(this.databaseDefinitionPage,this.format),this.pageDecrypter=function(e,t){switch(g(e).codecType){case 0:return P(e);default:return e=>e}}(this.databaseDefinitionPage)}getPassword(){let e=this.databaseDefinitionPage.slice(66,66+this.format.databaseDefinitionPage.passwordSize);const t=this.getPasswordMask();if(null!==t&&(e=D(e,t)),p(e))return null;let n=x(e,this.format);const i=n.indexOf("\0");return i>=0&&(n=n.slice(0,i)),n}getPasswordMask(){if(null===this.format.databaseDefinitionPage.creationDateOffset)return null;const e=Buffer.alloc(this.format.databaseDefinitionPage.passwordSize),t=this.databaseDefinitionPage.readDoubleLE(this.format.databaseDefinitionPage.creationDateOffset);e.writeInt32LE(Math.floor(t));for(let t=0;t<e.length;++t)e[t]=e[t%4];return e}getCreationDate(){if(null===this.format.databaseDefinitionPage.creationDateOffset)return null;return e(this.databaseDefinitionPage.slice(this.format.databaseDefinitionPage.creationDateOffset,this.format.databaseDefinitionPage.creationDateOffset+8))}getDefaultSortOrder(){const e=this.databaseDefinitionPage.readUInt16LE(this.format.databaseDefinitionPage.defaultSortOrder.offset+3);if(0===e)return this.format.defaultSortOrder;let t=this.format.defaultSortOrder.version;return 4==this.format.databaseDefinitionPage.defaultSortOrder.size&&(t=this.databaseDefinitionPage.readUInt8(this.format.databaseDefinitionPage.defaultSortOrder.offset+3)),Object.freeze({value:e,version:t})}getPage(e){if(0===e)return this.databaseDefinitionPage;const t=e*this.format.pageSize;if(this.buffer.length<t)throw new Error(`Page ${e} does not exist`);const n=this.buffer.slice(t,t+this.format.pageSize);return this.pageDecrypter(n,e)}findPageRow(e){const t=e>>8,n=255&e,i=this.getPage(t);return this.findRow(i,n)}findRow(e,t){const n=this.format.dataPage.recordCountOffset;if(t>1e3)throw new Error("Cannot read rows > 1000");const i=e.readUInt16LE(n+2+2*t),a=0===t?this.format.pageSize:e.readUInt16LE(n+2*t);return e.slice(i,a)}}const S=Buffer.from([199,218,57,107]);var E;!function(e){e[e.Form=0]="Form",e[e.Table=1]="Table",e[e.Macro=2]="Macro",e[e.SystemTable=3]="SystemTable",e[e.Report=4]="Report",e[e.Query=5]="Query",e[e.LinkedTable=6]="LinkedTable",e[e.Module=7]="Module",e[e.Relationship=8]="Relationship",e[e.DatabaseProperty=11]="DatabaseProperty"}(E||(E={}));const C={1:"boolean",2:"byte",3:"integer",4:"long",5:"currency",6:"float",7:"double",8:"datetime",9:"binary",10:"text",11:"ole",12:"memo",15:"repid",16:"numeric",18:"complex",19:"bigint",20:"datetimextended"};function U(e){const t=C[e];if(void 0===t)throw new Error("Unsupported column type");return t}function L(e){return e.readInt32LE()}function v(e){const t=[...e],n=t.length;for(let e=0;e<n-1;++e)t[e+1]+=Math.floor(t[e]/10),t[e]=t[e]%10;return t[n-1]=t[n-1]%10,t}function z(e,t){if(e.length!==t.length)throw new Error("Array a and b must have the same length");const n=new Array(e.length).fill(0);for(let i=0;i<e.length;++i)if(0!==e[i])for(let a=0;a<t.length;a++)n[i+a]+=e[i]*t[a];return v(n.slice(0,e.length))}function T(e,t){if(e.length!==t.length)throw new Error("Array a and b must have the same length");const n=e.length,i=[];for(let a=0;a<n;++a)i[a]=e[a]+t[a];return v(i)}function B(e,t){return v([e,...new Array(t-1).fill(0)])}function M(e,t,n){let i,a="";for(n&&(a+="-"),i=e.length;i>0&&i-1>t&&!e[i-1];i--);if(0===i)a+="0";else for(let n=i;n>0;n--)n===t&&(a+="."),a+=e[n-1].toString();return a}const j={binary:function(e){const t=Buffer.alloc(e.length);return e.copy(t),t},byte:function(e){return e.readUInt8()},complex:L,currency:function(e){let t=B(0,20),n=B(1,20);const i=e.slice(0,8);let a=!1;if(128&i[7]){a=!0;for(let e=0;e<8;++e)i[e]=~i[e];for(let e=0;e<8&&(++i[e],0==i[e]);++e);}for(const e of i)t=T(t,z(n,B(e,20))),n=z(n,B(256,20));return M(t,4,a)},datetime:e,double:function(e){return e.readDoubleLE()},float:function(e){return e.readFloatLE()},integer:function(e){return e.readInt16LE()},long:L,text:function(e,t,n){return x(e,n.format)},memo:function(e,t,n){const i=e.readUIntLE(0,3),a=e.readUInt8(3);if(128&a)return x(e.slice(12,12+i),n.format);if(64&a){const t=e.readUInt32LE(4);return x(n.findPageRow(t).slice(0,i),n.format)}if(0===a){let t=e.readInt32LE(4),a=Buffer.alloc(0);do{const r=n.findPageRow(t);if(a.length+r.length-4>i)break;if(0===r.length)break;a=Buffer.concat([a,r.slice(4,e.length)]),t=r.readInt32LE(0)}while(0!==t);return x(a.slice(0,i),n.format)}throw new Error(`Unknown memo type ${a}`)},numeric:function(e,t){let n=B(0,40),i=B(1,40);const a=e.slice(1,17);for(let e=0;e<a.length;++e){n=T(n,z(i,B(a[12-4*Math.floor(e/4)+e%4],40))),i=z(i,B(256,40))}const r=!!(128&e[0]);return M(n,t.scale,r)},ole:function(e,t,n){const i=e.readUIntLE(0,3),a=e.readUInt8(3);if(128&a)return e.slice(12,12+i);if(64&a){const t=e.readUInt32LE(4);return n.findPageRow(t).slice(0,i)}if(0===a){let t=e.readInt32LE(4),a=Buffer.alloc(0);do{const r=n.findPageRow(t);if(a.length+r.length-4>i)break;if(0===r.length)break;a=Buffer.concat([a,r.slice(4,e.length)]),t=r.readUInt32LE(0)}while(0!==t);return a.slice(0,i)}throw new Error(`Unknown memo type ${a}`)},repid:function(e){return e.slice(0,4).swap32().toString("hex")+"-"+e.slice(4,6).swap16().toString("hex")+"-"+e.slice(6,8).swap16().toString("hex")+"-"+e.slice(8,10).toString("hex")+"-"+e.slice(10,16).toString("hex")},bigint:void 0,datetimextended:void 0};function k(e,t,n){if("boolean"===t.type)throw new Error("readFieldValue does not handle type boolean");const i=j[t.type];return i?i(e,t,n):`Column type ${t.type} is currently not supported`}function F(e,t){switch(e[0]){case 0:return function(e){const t=e.readUInt32LE(1);return R(e.slice(5),t)}(e);case 1:return function(e,t){const n=8*(t.format.pageSize-4),i=Math.floor((e.length-1)/4),a=[];for(let r=0;r<i;++r){const i=e.readUInt32LE(1+4*r);if(0===i)continue;const o=t.getPage(i);w(o,O.PageUsageBitmaps);const f=o.slice(4);a.push(...R(f,r*n))}return a}(e,t);default:throw new Error("Unknown usage map type")}}function R(e,t){const n=[];for(let i=0;i<8*e.length;i++)b(e,i)&&n.push(t+i);return n}class N{constructor(e,t,n){this.name=e,this.db=t,this.firstDefinitionPage=n;let i,a=this.firstDefinitionPage;for(;a>0;){const e=this.db.getPage(a);w(e,O.TableDefinition),i=i?Buffer.concat([i,e.slice(8)]):e,a=e.readUInt32LE(4)}this.definitionBuffer=i,this.rowCount=this.definitionBuffer.readUInt32LE(this.db.format.tableDefinitionPage.rowCountOffset),this.columnCount=this.definitionBuffer.readUInt16LE(this.db.format.tableDefinitionPage.columnCountOffset),this.variableColumnCount=this.definitionBuffer.readUInt16LE(this.db.format.tableDefinitionPage.variableColumnCountOffset),this.fixedColumnCount=this.columnCount-this.variableColumnCount,this.logicalIndexCount=this.definitionBuffer.readInt32LE(this.db.format.tableDefinitionPage.logicalIndexCountOffset),this.realIndexCount=this.definitionBuffer.readInt32LE(this.db.format.tableDefinitionPage.realIndexCountOffset);const r=this.db.findPageRow(this.definitionBuffer.readUInt32LE(this.db.format.tableDefinitionPage.usageMapOffset));this.dataPages=F(r,this.db)}getColumn(e){const t=this.getColumns().find((t=>t.name===e));if(void 0===t)throw new Error(`Could not find column with name ${e}`);return t}getColumns(){const e=this.getColumnDefinitions();return e.sort(((e,t)=>e.index-t.index)),e.map((({index:e,variableIndex:t,fixedIndex:n,...i})=>i))}getColumnDefinitions(){const e=[];let t=this.db.format.tableDefinitionPage.realIndexStartOffset+this.realIndexCount*this.db.format.tableDefinitionPage.realIndexEntrySize,n=t+this.columnCount*this.db.format.tableDefinitionPage.columnsDefinition.entrySize;for(let a=0;a<this.columnCount;++a){const a=this.definitionBuffer.slice(t,t+this.db.format.tableDefinitionPage.columnsDefinition.entrySize),r=U(this.definitionBuffer.readUInt8(t+this.db.format.tableDefinitionPage.columnsDefinition.typeOffset)),o=this.definitionBuffer.readUIntLE(n,this.db.format.tableDefinitionPage.columnNames.nameLengthSize);n+=this.db.format.tableDefinitionPage.columnNames.nameLengthSize;const f=x(this.definitionBuffer.slice(n,n+o),this.db.format);n+=o;const s={name:f,type:r,index:a.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.indexOffset),variableIndex:a.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.variableIndexOffset),size:"boolean"===r?0:a.readUInt16LE(this.db.format.tableDefinitionPage.columnsDefinition.sizeOffset),fixedIndex:a.readUInt16LE(this.db.format.tableDefinitionPage.columnsDefinition.fixedIndexOffset),...(i=a.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.flagsOffset),{fixedLength:!!(1&i),nullable:!!(2&i),autoLong:!!(4&i),autoUUID:!!(64&i)})};"numeric"===r&&(s.precision=a.readUInt8(11),s.scale=a.readUInt8(12)),e.push(s),t+=this.db.format.tableDefinitionPage.columnsDefinition.entrySize}var i;return e}getColumnNames(){return this.getColumns().map((e=>e.name))}getData(e){var t,n;const i=[],a=this.getColumnDefinitions().filter((t=>void 0===(null==e?void 0:e.columns)||e.columns.includes(t.name))),r=null!==(t=null==e?void 0:e.rowOffset)&&void 0!==t?t:0,o=null!==(n=null==e?void 0:e.rowLimit)&&void 0!==n?n:1/0;for(const e of this.dataPages)i.length>=r+o||i.push(...this.getDataFromPage(e,a));return i.slice(r,r+o)}getDataFromPage(e,t){const n=this.db.getPage(e);if(w(n,O.DataPage),n.readUInt32LE(4)!==this.firstDefinitionPage)throw new Error(`Data page ${e} does not belong to table ${this.name}`);const i=n.readUInt16LE(this.db.format.dataPage.recordCountOffset),a=[];for(let e=0;e<i;++e){const t=8191;let i=n.readUInt16LE(this.db.format.dataPage.record.countOffset+2+2*e);if(16384&i)continue;i&=t;const r=i+((0===e?this.db.format.pageSize:n.readUInt16LE(this.db.format.dataPage.record.countOffset+2*e)&t)-i)-1;a.push({start:i,end:r})}const r=Math.max(...t.map((e=>e.index)),0),o=[];for(const e of a){const i=e.start,a=e.end,f=n.readUIntLE(i,this.db.format.dataPage.record.columnCountSize),s=m(f);let l=0;const u=[];if(this.variableColumnCount>0)switch(this.db.format.legacyFormat){case"Jet3":{l=n.readUInt8(a-s);const e=a-i+1;let t=Math.floor((e-1)/256);const r=a-s-t-1;(r-i-l)/256<t&&--t;let o=0;for(let e=0;e<l+1;++e){for(;o<t&&e===n.readUInt8(a-s-o-1);)++o;u.push(n.readUInt8(r-e)+256*o)}break}case"Jet4":l=n.readUInt16LE(a-s-1);for(let e=0;e<l+1;++e)u.push(n.readUInt16LE(a-s-3-2*e))}const d=f-l,c=n.slice(a-s+1,a-s+1+m(r+1));let h=0;const g={};for(const e of[...t].sort(((e,t)=>e.index-t.index))){let t,a,r;if(b(c,e.index)||(t=null),e.fixedLength&&h<d){a=i+(e.fixedIndex+this.db.format.dataPage.record.columnCountSize),r=e.size,++h}else if(!e.fixedLength&&e.variableIndex<l){const t=u[e.variableIndex];a=i+t,r=u[e.variableIndex+1]-t}else a=0,t=null,r=0;"boolean"===e.type?t=void 0===t:null!==t&&(t=k(n.slice(a,a+r),e,this.db)),g[e.name]=t}o.push(g)}return o}}class ${constructor(e){this._buffer=e,w(this._buffer,O.DatabaseDefinitionPage),this.db=new y(this._buffer);const t=new N("MSysObjects",this.db,2).getData({columns:["Id","Name","Type","Flags"]});this.sysObjects=t.map((e=>{const t=127&e.Type;return{objectName:e.Name,objectType:(n=t,Object.values(E).includes(n)?t:null),tablePage:16777215&e.Id,flags:e.Flags};var n}))}get buffer(){return this._buffer}getFormat(){return this.db.format.legacyFormat}getCreationDate(){return this.db.getCreationDate()}getPassword(){return this.db.getPassword()}getDefaultSortOrder(){return this.db.getDefaultSortOrder()}getTableNames({normalTables:e,systemTables:t,linkedTables:n}={normalTables:!0,systemTables:!1,linkedTables:!1}){const i=[];for(const a of this.sysObjects)a.objectType===E.Table?0==(-2147483646&a.flags)?e&&i.push(a):t&&i.push(a):a.objectType===E.LinkedTable&&n&&i.push(a);return i.map((e=>e.objectName))}getTable(e){const t=this.sysObjects.filter((e=>e.objectType===E.Table)).find((t=>t.objectName===e));if(!t)throw new Error(`Could not find table with name ${e}`);return new N(e,this.db,t.tablePage)}}export{$ as default};
